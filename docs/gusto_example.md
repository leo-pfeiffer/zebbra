# Gusto Integration Example
## Setup
Create gusto account
Add Client ID, Client Secret to .env
Add client id, secrets etc. to settings.py (optional, but recommended)
```python
# core/settings.py >

class Settings(BaseSettings):
    ...
    GUSTO_CLIENT_ID: str  
    GUSTO_CLIENT_SECRET: str  
    GUSTO_CONF_URL: str = "https://api.gusto-demo.com/.well-known/openid-configuration"  
    GUSTO_API_BASE_URL: str = "https://api.gusto-demo.com/"  
    GUSTO_REFRESH_URL: str = "https://api.gusto-demo.com/oauth/token"  
    GUSTO_AUTHORIZE_URL: str = "https://api.gusto-demo.com/oauth/authorize"
    ...
```

Add integration provider in `core/schemas/integrations.py`
```python
IntegrationProvider = Literal["Xero", "Gusto"]
```

Run `make generate_from_template INTEGRATION=Gusto`
    > Generates `gusto_adapter.py`
    > Generates `gusto_integration_oauth.py`

Implement methods for `GustoIntegrationOAuth`

```python
# If you've specified settings in settings.py, get access:
settings = get_settings()  
 
 
class GustoIntegrationOAuth(IntegrationOAuth):

    # fill in integration provider
    _integration: IntegrationProvider = "Gusto"  
  
    # Override the constructor (always the same)
    def __init__(self):
        super().__init__()  

    # Override the integration getter (always the same)
    @classmethod  
    def integration(cls):
        return cls._integration  
  
    # define the token refresh flow
    async def _perform_token_refresh(self, integration_access: IntegrationAccess):
        
        # start by making a POST request to the login url
        response = await self.oauth_app.post(  
            settings.GUSTO_REFRESH_URL,  # for Gusto, LOGIN_URL = REFRESH_URL
            data={  
                "client_id": settings.GUSTO_CLIENT_ID,  
                "client_secret": settings.GUSTO_CLIENT_SECRET,  
                "redirect_uri": "http://localhost:8000/integration/gusto/callback",
                "refresh_token": integration_access.token.refresh_token,  
                "grant_type": "refresh_token",  
            },  
        )  
  
        # process the response to extract the token
        token = await self._process_refresh_response(response, integration_access)  
  
        # update token in DB
        await self._store_oauth_token(integration_access.workspace_id, token)

        # return the new integration access object
        return await get_integration_for_workspace(  
            integration_access.workspace_id, self.integration()  
        )  
  
    # helper method to extract token from authorize response
    async def _process_refresh_response(  
        self, response, integration_access: IntegrationAccess
    ) -> IntegrationAccessToken:
      
      # if status is ok, simply take the response body
      if response.status_code == 200:  
            token_data = response.json()
            if "expires_at" not in token_data:  
                token_data["expires_at"] = token_data["expires_in"] + int(time.time())  
            return IntegrationAccessToken(**token_data)  
  
      # Can't refresh token -> set the requires_reconnect value of the integration  
      #  access to True, indicating that the user has to go through the OAuth 
      #  connection workflow to reconnect the integration. The integration access ID 
      #  remains the same.  
      await set_requires_reconnect(
          integration_access.workspace_id,self.integration(), True
      )
  
      raise HTTPException(  
          status_code=status.HTTP_400_BAD_REQUEST,  
          detail="Token refresh failed.",  
      )
  
    # implement method to store the new token in the DB
    async def _store_oauth_token(self, workspace_id, token: IntegrationAccessToken):
        integration_access = IntegrationAccess(  
            integration=self.integration(),  
            workspace_id=workspace_id,  
            token=token,  
            requires_reconnect=False,  
        )  
  
        return await add_integration_for_workspace(integration_access)
```


Create instance and register OAuth app
```python
gusto_integration_oauth = GustoIntegrationOAuth()  

# here we use the settings from settings.py
gusto_integration_oauth.register_oauth_app(  
    name="Gusto",  
    client_id=settings.GUSTO_CLIENT_ID,  
    client_secret=settings.GUSTO_CLIENT_SECRET,  
    server_metadata_url=settings.GUSTO_CONF_URL,  
    api_base_url=settings.XERO_API_BASE_URL,  
    authorize_url=settings.GUSTO_AUTHORIZE_URL,  
    access_token_url=settings.GUSTO_REFRESH_URL,  
)
```

The endpoints are autogenerated:
```python
@gusto_integration_oauth.router.get(**gusto_integration_oauth.login_endpoint())  
async def login_route(  
    workspace_id: str,  
    request: Request,  
    current_user: User = Depends(get_current_active_user_url),  
):  
    return await gusto_integration_oauth.oauth_login(  
        workspace_id, request, current_user  
  )  
  
  
@gusto_integration_oauth.router.get(**gusto_integration_oauth.callback_endpoint())  
async def callback_route(request: Request):  
    return await gusto_integration_oauth.oauth_callback(request)
```

Register `gusto_integration_oauth` in `config.py`

```python
# core/integrations/config.py

from core.integrations.oauth.xero_oauth import xero_integration_oauth

...

def setup_integrations(app: FastAPI):
    ...
    # register the IntegrationOAuth implementation *instance* here  
    _register_oauth(xero_integration_oauth)  
    _register_oauth(gusto_integration_oauth)  # add this
    ...
```

### Checkpoint > Can now authorize app with oauth

