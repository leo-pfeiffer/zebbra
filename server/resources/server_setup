adduser zebbra
usermod -aG sudo zebbra

# log in as zebbra

## INSTALL PYTHON
sudo apt update -y

sudo apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev libffi-dev liblzma-dev python-openssl git

git clone https://github.com/pyenv/pyenv.git ~/.pyenv

echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n eval "$(pyenv init --path)"\nfi' >> ~/.bashrc

exec $SHELL

echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.profile
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.profile
echo 'eval "$(pyenv init --path)"' >> ~/.profile
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.zprofile
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.zprofile
echo 'eval "$(pyenv init --path)"' >> ~/.zprofile

source .bashrc

pyenv install 3.10.3


# Install mongodb

wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
echo "mongodb-org hold" | sudo dpkg --set-selections
echo "mongodb-org-database hold" | sudo dpkg --set-selections
echo "mongodb-org-server hold" | sudo dpkg --set-selections
echo "mongodb-org-shell hold" | sudo dpkg --set-selections
echo "mongodb-org-mongos hold" | sudo dpkg --set-selections
echo "mongodb-org-tools hold" | sudo dpkg --set-selections

sudo systemctl start mongod
sudo systemctl status mongod


# Connect github
ssh-keygen -t ed25519
cat .ssh/id_ed25519  # add to github

git clone git@github.com:leo-pfeiffer/zebbra.git
cd zebbra/server
python -m venv venv
source venv/bin/activate

pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn

# PASTE .env file

make setup_db_export

# confirm this works:
gunicorn --bind 0.0.0.0:5000 main:app -k uvicorn.workers.UvicornWorker


# set up nginx
sudo apt install python3-dev build-essential libssl-dev libffi-dev python3-setuptools

sudo nano /etc/systemd/system/zebbra.service


## Paste:
# [Unit]
# Description=Gunicorn instance to serve Zebbra API
# After=network.target

# [Service]
# User=zebbra
# Group=www-data
# WorkingDirectory=/home/zebbra/zebbra/server
# Environment="PATH=/home/zebbra/zebbra/server/venv/bin"
# ExecStart=/home/zebbra/zebbra/server/venv/bin/gunicorn --workers 3 --bind unix:zebbra.sock -m 007 main:app -k uvicorn.workers.UvicornWorker

# [Install]
# WantedBy=multi-user.target

sudo systemctl start zebbra
sudo systemctl enable zebbra
sudo systemctl status zebbra


# Install nginx
sudo apt update
sudo apt install nginx
sudo ufw allow 'Nginx HTTP'


sudo nano /etc/nginx/sites-available/zebbra

## Paste:
# server {
#     listen 80;
#     server_name zebbra.xyz www.zebbra.xyz;

#     location / {
#         include proxy_params;
#         proxy_pass http://unix:/home/zebbra/zebbra/server/zebbra.sock;
#     }
# }

sudo ln -s /etc/nginx/sites-available/zebbra /etc/nginx/sites-enabled
sudo nginx -t
sudo systemctl restart nginx

sudo ufw delete allow 5000
sudo ufw allow 'Nginx Full'

# Cert
sudo apt install python3-certbot-nginx

sudo certbot --nginx -d zebbra.xyz -d www.zebbra.xyz

sudo ufw delete allow 'Nginx HTTP'
